{
  "version": 3,
  "sources": ["../src/system.ts", "../src/effect.ts", "../../shared/src/index.ts", "../src/dep.ts", "../src/baseHandlers.ts", "../src/reactive.ts", "../src/ref.ts", "../src/computed.ts", "../src/watch.ts"],
  "sourcesContent": ["import { ReactiveEffect as Effect } from './effect'\nimport { ComputedRefImpl as Computed } from './computed'\n\n/**\n * \u4F9D\u8D56\u9879\n */\nexport interface Dependency {\n  subsHead: Link | undefined\n  subsTail: Link | undefined\n}\n\nexport interface Subscriber {\n  tracking: boolean\n  dirty: boolean\n  depsHead: Link | undefined\n  depsTail: Link | undefined\n}\n\n/**\n * \u94FE\u8868\u8282\u70B9\n */\nexport interface Link {\n  sub: Subscriber | Effect | Computed\n  nextSub: Link | undefined\n  prevSub: Link | undefined\n  dep: Dependency | Computed\n  nextDep: Link | undefined\n}\n\nlet linkPool: Link\n\n/**\n * \u8282\u70B9\n * @param dep \u5F53\u524D\u7684 ref\n * @param sub \u4E34\u65F6\u8BA2\u9605\u4E8B\u4EF6\n */\nexport function link(dep: Dependency, sub: Subscriber): Link | undefined {\n  //region \u94FE\u8868\u590D\u7528\n  const currentDep = sub.depsTail\n\n  const nextDep = currentDep === undefined ? sub.depsHead : currentDep.nextDep\n  if (nextDep?.dep === dep) {\n    sub.depsTail = nextDep\n    return\n  }\n\n  /**\n   * \u770B\u4E00\u4E0B linkPool \u6709\u6CA1\u6709\uFF0C\u5982\u679C\u6709\uFF0C\u5C31\u590D\u7528\n   */\n  let newLink: Link\n  if (linkPool) {\n    newLink = linkPool\n    linkPool = linkPool.nextDep\n    newLink.nextDep = nextDep\n    newLink.dep = dep\n    newLink.sub = sub\n  } else {\n    // \u5982\u679C\u6709\uFF0C\u5C31\u521B\u5EFA\u65B0\u8282\u70B9\n    newLink = {\n      sub,\n      nextSub: undefined,\n      prevSub: undefined,\n      dep,\n      nextDep,\n    }\n  }\n  //endregion\n\n  //region \u5C06\u94FE\u8868\u8282\u70B9\u548C dep \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\n  // \u5C06\u8282\u70B9\u653E\u5165\u672C ref \u7684\u8BA2\u9605\u8005\u94FE\u8868\u4E2D\n  if (dep.subsTail) {\n    // \u5982\u679C\u6709\u5C3E\u8282\u70B9 => \u4E0D\u662F\u5934\u8282\u70B9 => \u5728\u94FE\u8868\u540E\u9762\u52A0\u5165\n    dep.subsTail.nextSub = newLink\n    newLink.prevSub = dep.subsTail\n    dep.subsTail = newLink\n  } else {\n    // \u5982\u679C\u65E0\u5C3E\u8282\u70B9 => \u662F\u5934\u8282\u70B9 => \u8BBE\u7F6E\u4E3A\u5934\u8282\u70B9\n    dep.subsHead = newLink\n    dep.subsTail = newLink\n  }\n  //endregion\n\n  //region \u5C06\u94FE\u8868\u8282\u70B9\u548C sub \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\n  // \u5C06\u8282\u70B9\u653E\u5165\u672C ref \u7684\u4F9D\u8D56\u9879\u94FE\u8868\u4E2D\n  if (sub.depsTail) {\n    // \u5982\u679C\u6709\u5C3E\u8282\u70B9 => \u4E0D\u662F\u5934\u8282\u70B9 => \u5728\u94FE\u8868\u540E\u9762\u52A0\u5165\n    sub.depsTail.nextDep = newLink\n    sub.depsTail = newLink\n  } else {\n    // \u5982\u679C\u65E0\u5C3E\u8282\u70B9 => \u662F\u5934\u8282\u70B9 => \u8BBE\u7F6E\u4E3A\u5934\u8282\u70B9\n    sub.depsHead = newLink\n    sub.depsTail = newLink\n  }\n  //endregion\n}\n\nfunction processComputedUpdate(sub: Computed) {\n  /**\n   * \u66F4\u65B0\u8BA1\u7B97\u5C5E\u6027\n   * 1. \u8C03\u7528 update\n   * 2. \u901A\u77E5 subs \u94FE\u8868\u4E0A\u6240\u6709\u7684 sub\uFF0C\u91CD\u65B0\u6267\u884C\n   */\n  if (sub.subsHead && sub.update()) {\n    propagate(sub.subsHead)\n  }\n}\n\n/**\n * \u4F20\u64AD\u66F4\u65B0\u7684\u51FD\u6570\n * @param subs\n */\nexport function propagate(subs: Link) {\n  let link = subs\n  let queuedEffect = []\n  while (link) {\n    const sub = link.sub\n    if (!sub.tracking && !sub.dirty) {\n      sub.dirty = true\n      if ('update' in sub) {\n        processComputedUpdate(sub)\n      } else {\n        queuedEffect.push(sub)\n      }\n    }\n    link = link.nextSub\n  }\n  queuedEffect.forEach(effect => effect.notify())\n}\n\n/**\n * \u5F00\u59CB\u8FFD\u8E2A\u4F9D\u8D56\uFF0C\u5C06 depsTail\uFF0C\u5C3E\u8282\u70B9\u8BBE\u7F6E\u6210 undefined\n * @param sub\n */\nexport function startTracking(sub: Subscriber): void {\n  sub.tracking = true\n  sub.depsTail = undefined\n}\n\n/**\n * \u7ED3\u675F\u8FFD\u8E2A\u4F9D\u8D56\uFF0C\u627E\u5230\u9700\u8981\u6E05\u7406\u7684\u4F9D\u8D56\uFF0C\u65AD\u5F00\u5173\u8054\u5173\u7CFB\n * @param sub\n */\nexport function endTracking(sub: Subscriber): void {\n  sub.tracking = false\n  const depsTail = sub.depsTail\n  sub.dirty = false\n  /**\n   * depsTail \u6709\uFF0C\u5E76\u4E14\u8FD8\u6709 nextDep\uFF0C\u6211\u4EEC\u5E94\u8BE5\u628A\u5B83\u4EEC\u7684\u4F9D\u8D56\u5173\u7CFB\u6E05\u9664\n   * depsTail \u6CA1\u6709\uFF0C\u5E76\u4E14\u5934\u8282\u70B9\u6709\uFF0C\u90A3\u5C31\u628A\u6240\u6709\u7684\u90FD\u6E05\u7406\u6389\n   */\n  if (depsTail) {\n    if (depsTail.nextDep) {\n      clearTracking(depsTail.nextDep)\n      depsTail.nextDep = undefined\n    }\n  } else if (sub.depsHead) {\n    clearTracking(sub.depsHead)\n    sub.depsHead = undefined\n  }\n}\n\n/**\n * \u6E05\u9664\u8FFD\u8E2A\n * @param link\n */\nexport function clearTracking(link: Link) {\n  while (link) {\n    const { nextDep, nextSub, dep, prevSub } = link\n\n    /**\n     * \u5982\u679C prevSub \u6709\uFF0C\u90A3\u5C31\u628A prevSub = nextSub\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u90A3\u5C31\u662F\u5934\u8282\u70B9\uFF0C\u90A3\u5C31\u628A dep.subs \u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\u8282\u70B9\n     */\n    if (prevSub) {\n      prevSub.nextSub = nextSub\n      link.nextSub = undefined\n    } else {\n      dep.subsHead = nextSub\n    }\n\n    /**\n     * \u5982\u679C nextSub \u6709\uFF0C\u90A3\u5C31\u628A nextSub = prevSub\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u90A3\u5C31\u662F\u5C3E\u8282\u70B9\uFF0C\u90A3\u5C31\u628A dep.depsTail \u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0A\u4E00\u4E2A\u8282\u70B9\n     */\n    if (nextSub) {\n      nextSub.prevSub = prevSub\n      link.prevSub = undefined\n    } else {\n      dep.subsTail = prevSub\n    }\n\n    link.dep = link.sub = undefined\n\n    // \u628A\u4E0D\u8981\u7684\u8282\u70B9\u7ED9 linkPool\n    link.nextDep = linkPool\n    linkPool = link\n\n    link = nextDep\n  }\n}\n", "// \u4E34\u65F6\u9700\u8981\u6267\u884C\u7684\u8BA2\u9605\u4E8B\u4EF6\nimport { endTracking, Link, startTracking, Subscriber } from './system'\n\nexport class ReactiveEffect<T = any> implements Subscriber {\n  depsHead: Link | undefined\n  depsTail: Link | undefined\n  tracking: boolean = false\n  dirty: boolean = false\n  // \u8868\u793A\u8FD9\u4E2A effect \u662F\u5426\u6FC0\u6D3B\n  active: boolean = true\n\n  constructor(public fn: () => T) {}\n\n  run(): T {\n    if (!this.active) {\n      return this.fn()\n    }\n    const prevSub: Subscriber | undefined = activeSub\n\n    // \u6BCF\u6B21\u6267\u884C fn \u4E4B\u524D\uFF0C\u628A this \u653E\u5230 activeSub \u4E0A\u9762\n    setActiveSub(this)\n    startTracking(this)\n    try {\n      return this.fn()\n    } finally {\n      // \u6267\u884C\u5B8C\u6210\u540E\uFF0C\u6062\u590D\u4E4B\u524D\u7684 activeSub\n      setActiveSub(prevSub)\n      endTracking(this)\n    }\n  }\n\n  /**\n   * \u901A\u77E5\u66F4\u65B0\u7684\u65B9\u6CD5\uFF0C\u5982\u679C\u4F9D\u8D56\u7684\u6570\u636E\u53D1\u751F\u53D8\u5316\uFF0C\u4F1A\u8C03\u7528\u8FD9\u4E2A\u51FD\u6570\n   */\n  notify() {\n    this.scheduler()\n  }\n\n  /**\n   * \u9ED8\u8BA4\u8C03\u7528 run\uFF0C\u5982\u679C\u7528\u6237\u4F20\u4E86\uFF0C\u90A3\u4EE5\u7528\u6237\u7684\u4E3A\u4E3B\n   */\n  scheduler() {\n    this.run()\n  }\n\n  stop() {\n    if (this.active) {\n      // \u6E05\u7406\u4F9D\u8D56\n      startTracking(this)\n      endTracking(this)\n      this.active = false\n    }\n  }\n}\n\n/**\n * \u8BA2\u9605 ref\n * @param fn \u8BA2\u9605\u4E8B\u4EF6\n * @param options\n */\nexport function effect<T = any>(fn: () => T, options?: any) {\n  const e = new ReactiveEffect(fn)\n  // scheduler\n  Object.assign(e, options)\n\n  e.run()\n\n  // \u7ED1\u5B9A\u51FD\u6570\u7684 this\n  const runner = e.run.bind(e)\n  // \u628A effect \u7684\u5B9E\u4F8B\uFF0C\u653E\u5230\u51FD\u6570\u5C5E\u6027\u4E2D\n  runner.effect = e\n  return runner\n}\n\nexport let activeSub: Subscriber | undefined = undefined\n\nexport function setActiveSub(sub: Subscriber | undefined): void {\n  activeSub = sub\n}\n", "export function isObject(value: unknown): value is Object {\n  return typeof value === 'object' && value !== null\n}\n\nexport function isFunction(value: unknown): value is Function {\n  return typeof value === 'function'\n}\n\nexport const isArray: typeof Array.isArray = Array.isArray\n\nexport function hasChanged<T>(newValue: T, oldValue: T): boolean {\n  return !Object.is(newValue, oldValue)\n}\n", "import { activeSub } from './effect'\nimport { type Dependency, type Link, link, propagate } from './system'\nimport { isArray } from '@vue/shared'\n\nclass Dep implements Dependency {\n  subsHead: Link\n  subsTail: Link\n}\n\ntype KeyToDepMap = Map<any, Dep>\n\nconst targetMap: WeakMap<object, KeyToDepMap> = new WeakMap()\n\nexport function track(target: object, key: any): void {\n  if (!activeSub) return\n\n  let depsMap = targetMap.get(target)\n\n  if (!depsMap) {\n    depsMap = new Map()\n    targetMap.set(target, depsMap)\n  }\n\n  let dep = depsMap.get(key)\n\n  if (!dep) {\n    dep = new Dep()\n    depsMap.set(key, dep)\n  }\n\n  link(dep, activeSub)\n}\n\nexport function trigger(target: object, key: any): void {\n  const depsMap = targetMap.get(target)\n  if (!depsMap) return\n\n  const targetArray = isArray(target)\n  if (targetArray && key === 'length') {\n    /**\n     * \u66F4\u65B0\u6570\u636E\u7684 length\n     * \u66F4\u65B0\u524D\uFF1Alength = 4 => ['a','b','c','d']\n     * \u66F4\u65B0\u524D\uFF1Alength = 2 => ['a','b']\n     * \u5F97\u51FA\u7ED3\u8BBA\uFF1A\u8981\u901A\u77E5 \u8BBF\u95EE\u4E86 c \u548C d \u7684 effect \u91CD\u65B0\u6267\u884C\uFF0C\u5C31\u662F\u8BBF\u95EE\u4E86>= length \u7684\u7D22\u5F15\n     * depsMap = {\n     *   0:Dep,\n     *   1:Dep,\n     *   2:Dep,\n     *   3:Dep,\n     *   length:Dep\n     * }\n     */\n    const length = target.length\n    depsMap.forEach((dep, depKey) => {\n      if (depKey >= length || depKey === 'length') {\n        /**\n         * \u901A\u77E5 >= length \u7684 effect \u91CD\u65B0\u6267\u884C\n         * \u548C \u8BBF\u95EE\u4E86 length \u7684 effect \u91CD\u65B0\u6267\u884C\n         */\n        propagate(dep.subsHead)\n      }\n    })\n  } else {\n    // \u4E0D\u662F\u6570\u7EC4\uFF0C\u6216\u8005\u662F\u6570\u7EC4\u66F4\u65B0\u7684\u4E0D\u662F length\n    const dep = depsMap.get(key)\n    if (!dep) return\n\n    propagate(dep.subsHead)\n  }\n}\n", "import { track, trigger } from './dep'\nimport { hasChanged, isArray, isObject } from '@vue/shared'\nimport { isRef } from './ref'\nimport { reactive } from './reactive'\n\nclass BaseReactiveHandler implements ProxyHandler<object> {\n  get(target: object, key: string | symbol, receiver: any) {\n    // \u6536\u96C6\u4F9D\u8D56\uFF0C\u7ED1\u5B9A target \u4E2D\u67D0\u4E00\u4E2A key \u548C sub \u4E4B\u95F4\u7684\u5173\u7CFB\n    track(target, key)\n\n    const res = Reflect.get(target, key, receiver)\n    if (isRef(res)) return res.value\n    // \u5982\u679C\u4F20\u6765\u7684\u662F\u4E2A reactive({a: {b: 0}})\n    if (isObject(res)) return reactive(res)\n    return res\n  }\n}\n\nclass MutableReactiveHandler extends BaseReactiveHandler {\n  set(target: any, key: string | symbol, newValue: any, receiver: any) {\n    const oldValue = target[key]\n\n    const targetIsArray = isArray(target)\n    const oldLength = targetIsArray ? target.length : 0\n\n    // target = reactive({a:ref(0)}) ==> target.a = 1 ==> a.value = 1\n    if (isRef(oldValue) && !isRef(newValue)) {\n      oldValue.value = newValue\n      return true\n    }\n    // \u89E6\u53D1\u66F4\u65B0\uFF0Cset \u7684\u65F6\u5019\uFF0C\u901A\u77E5\u4E4B\u524D\u7684\u4F9D\u8D56\uFF0C\u91CD\u65B0\u6267\u884C\n    const res = Reflect.set(target, key, newValue, receiver)\n\n    if (hasChanged(newValue, oldValue)) trigger(target, key)\n\n    /**\n     * \u9690\u5F0F\u66F4\u65B0 length\n     * \u66F4\u65B0\u524D\uFF1Alength = 4 => ['a', 'b', 'c', 'd']\n     * \u66F4\u65B0\u540E\uFF1Alength = 5 => ['a', 'b', 'c', 'd', 'e']\n     * \u66F4\u65B0\u52A8\u4F5C\uFF0C\u4EE5 push \u4E3A\u4F8B\uFF0C\u8FFD\u52A0\u6709\u4E2A e\n     */\n    const newLength = targetIsArray ? target.length : 0\n\n    if (targetIsArray && newLength !== oldLength && key !== 'length') {\n      trigger(target, 'length')\n    }\n\n    return res\n  }\n}\n\nexport const mutableHandlers: ProxyHandler<object> =\n  new MutableReactiveHandler()\n", "import { isObject } from '@vue/shared'\nimport { mutableHandlers } from './baseHandlers'\n\nexport function reactive(target: object) {\n  return createReactiveObject(target)\n}\n\n// 1.1 \u4FDD\u5B58 target \u548C \u54CD\u5E94\u5F0F\u5BF9\u8C61\u4E4B\u95F4\u7684\u5173\u8054\u5173\u7CFB\nconst reactiveMap = new WeakMap()\n// 2.1 \u4FDD\u5B58\u6240\u6709\u4F7F\u7528 reactive \u521B\u5EFA\u51FA\u6765\u7684\u54CD\u5E94\u5F0F\u5BF9\u8C61\nconst reactiveSet = new WeakSet()\n\nfunction createReactiveObject(target: object) {\n  // reactive \u5FC5\u987B\u63A5\u53D7\u4E00\u4E2A\u5BF9\u8C61\n  if (!isObject(target)) return target\n\n  // 1.2 \u9632\u6B62\u4E00\u4E2A target \u88AB\u591A\u6B21 reactive\n  const existedProxy = reactiveMap.get(target)\n  if (existedProxy) return existedProxy\n\n  // 2.2 \u9632\u6B62\u4E00\u4E2A \u54CD\u5E94\u5F0F\u5BF9\u8C61\u518D\u6B21\u88AB reactive\n  if (isReactive(target)) return target\n\n  // \u521B\u5EFA target \u7684\u4EE3\u7406\u5BF9\u8C61\n  const proxy = new Proxy(target, mutableHandlers)\n\n  // 1.3 \u4FDD\u5B58 target \u548C proxy\u4E4B\u95F4\u7684\u5173\u8054\u5173\u7CFB\n  reactiveMap.set(target, proxy)\n  // 2.3 \u4FDD\u5B58\u6240\u6709 reactive \u4E2D\n  reactiveSet.add(proxy)\n  return proxy\n}\n\nexport function isReactive(target: object) {\n  return reactiveSet.has(target)\n}\n", "import { activeSub } from './effect'\nimport { type Dependency, type Link, link, propagate } from './system'\nimport { hasChanged, isObject } from '@vue/shared'\nimport { reactive } from './reactive'\nimport { ReactiveFlags } from './constants'\nimport { ComputedRef } from './computed'\n\nexport interface Ref<T = any, S = T> {\n  get value(): T\n\n  set value(_: S)\n}\n\nclass RefImpl<T = any> implements Dependency {\n  _value: T\n\n  subsHead: Link\n  subsTail: Link\n\n  public readonly [ReactiveFlags.IS_REF] = true\n\n  constructor(value: T) {\n    this._value = isObject(value) ? (reactive(value as object) as T) : value\n  }\n\n  get value() {\n    trackRef(this)\n    return this._value\n  }\n\n  set value(newValue) {\n    if (hasChanged(newValue, this._value)) {\n      this._value = isObject(newValue)\n        ? (reactive(newValue as object) as T)\n        : newValue\n      triggerRef(this)\n    }\n  }\n}\n\nexport function ref(value: unknown) {\n  return new RefImpl(value)\n}\n\n/**\n * \u6536\u96C6\u8BA2\u9605\n * @param dep\n */\nexport function trackRef(dep: RefImpl) {\n  if (activeSub) link(dep, activeSub)\n}\n\n/**\n * \u89E6\u53D1 ref \u5173\u8054\u7684\u6240\u6709 effect\n * @param dep\n */\nexport function triggerRef(dep: RefImpl) {\n  if (dep.subsHead) {\n    propagate(dep.subsHead)\n  }\n}\n\nclass ObjectRefImpl<T extends object, K extends keyof T> {\n  [ReactiveFlags.IS_REF] = true\n\n  constructor(\n    public _object: T,\n    public _key: K,\n  ) {}\n\n  get value() {\n    return this._object[this._key]\n  }\n\n  set value(newVal) {\n    this._object[this._key] = newVal\n  }\n}\n\nexport function unref<T>(ref: Ref<T> | ComputedRef<T>): T {\n  return isRef(ref) ? ref.value : ref\n}\n\nexport function isRef(r: any): r is Ref {\n  return r ? r[ReactiveFlags.IS_REF] === true : false\n}\n\nexport function toRef(target: Record<string, any>, key: string) {\n  return new ObjectRefImpl(target, key)\n}\n\nexport function toRefs(target: Record<string, any>) {\n  const res = {}\n\n  for (const key in target) {\n    res[key] = new ObjectRefImpl(target, key)\n  }\n\n  return res\n}\n\nexport function proxyRefs<T extends object>(target: T) {\n  return new Proxy(target, {\n    get(...args) {\n      const res = Reflect.get(...args)\n      return unref(res as any)\n    },\n    set(target, key, newValue, receiver) {\n      const oldValue = target[key]\n\n      if (isRef(oldValue) && !isRef(newValue)) {\n        oldValue.value = newValue\n        return true\n      }\n\n      return Reflect.set(target, key, newValue, receiver)\n    },\n  })\n}\n", "import { hasChanged, isFunction } from '@vue/shared'\nimport {\n  Dependency,\n  endTracking,\n  link,\n  Link,\n  startTracking,\n  Subscriber,\n} from './system'\nimport { ReactiveFlags } from './constants'\nimport { activeSub, setActiveSub } from './effect'\nimport { Ref } from './ref'\n\ninterface BaseComputedRef<T, S = T> extends Ref<T, S> {\n  effect: ComputedRefImpl\n}\n\nexport interface ComputedRef<T = any> extends BaseComputedRef<T> {\n  readonly value: T\n}\n\nexport type ComputedGetter<T> = (oldValue?: T) => T\nexport type ComputedSetter<T> = (newValue: T) => void\n\nexport interface WritableComputedOptions<T, S = T> {\n  get: ComputedGetter<T>\n  set: ComputedSetter<S>\n}\n\nexport class ComputedRefImpl<T = any> implements Dependency, Subscriber {\n  _value: T | undefined = undefined\n  // Dependency\n  subsHead: Link | undefined\n  subsTail: Link | undefined\n  // Subscriber\n  depsHead: Link | undefined\n  depsTail: Link | undefined;\n\n  [ReactiveFlags.IS_REF] = true\n  tracking: Boolean | undefined = false\n  dirty = true\n\n  constructor(\n    public fn: ComputedGetter<T>,\n    private readonly setter: ComputedSetter<T> | undefined,\n  ) {}\n\n  get value(): T {\n    if (this.dirty) {\n      this.update()\n    }\n    // \u8981\u548C sub \u505A\u5173\u8054\u5173\u7CFB\n    if (activeSub) link(this, activeSub)\n\n    return this._value\n  }\n\n  set value(newValue) {\n    if (this.setter) {\n      this._value = newValue\n    } else {\n      console.warn('readonly')\n    }\n  }\n\n  update(): boolean {\n    const prevSub: Subscriber | undefined = activeSub\n\n    // \u6BCF\u6B21\u6267\u884C fn \u4E4B\u524D\uFF0C\u628A this \u653E\u5230 activeSub \u4E0A\u9762\n    setActiveSub(this)\n    startTracking(this)\n    try {\n      const oldValue = this._value\n      this._value = this.fn()\n      return hasChanged(oldValue, this._value)\n    } finally {\n      // \u6267\u884C\u5B8C\u6210\u540E\uFF0C\u6062\u590D\u4E4B\u524D\u7684 activeSub\n      setActiveSub(prevSub)\n      endTracking(this)\n    }\n  }\n}\n\n/**\n * \u8BA1\u7B97\u5C5E\u6027\n * @param getterOrOptions\n */\nexport function computed<T>(\n  getterOrOptions: ComputedGetter<T> | WritableComputedOptions<T>,\n) {\n  let getter: ComputedGetter<T>\n  let setter: ComputedSetter<T> | undefined\n\n  if (isFunction(getterOrOptions)) {\n    getter = getterOrOptions\n  } else {\n    getter = getterOrOptions.get\n    setter = getterOrOptions.set\n  }\n\n  return new ComputedRefImpl(getter, setter)\n}\n", "import { ReactiveEffect } from './effect'\nimport { isRef, Ref } from './ref'\nimport { ComputedRef } from './computed'\nimport { isFunction, isObject } from '@vue/shared'\nimport { isReactive } from './reactive'\n\nexport type OnCleanup = (cleanupFn: () => void) => void\nexport type WatchEffect = (onCleanup: OnCleanup) => void\nexport type WatchSource<T = any> = Ref<T, any> | ComputedRef<T> | (() => T)\nexport type WatchCallback<V = any, OV = any> = (\n  value: V,\n  oldValue: OV,\n  onCleanup?: OnCleanup,\n) => any\n\nexport interface WatchOptions<Immediate = boolean> {\n  immediate?: Immediate\n  deep?: boolean | number\n  once?: boolean\n}\n\nexport function watch(\n  source: WatchSource | WatchSource[] | WatchEffect | object,\n  cb?: WatchCallback | null,\n  options: WatchOptions = {},\n) {\n  let { immediate, once, deep } = options\n\n  if (once) {\n    const _cb = cb\n    cb = (...args) => {\n      _cb(...args)\n      stop()\n    }\n  }\n  let getter: () => any\n  if (isRef(source)) {\n    getter = () => source.value\n  } else if (isReactive(source)) {\n    getter = () => source\n    if (!deep) deep = true\n  } else if (isFunction(source)) {\n    getter = source as () => any\n  }\n\n  if (deep) {\n    const baseGetter = getter\n    const depth = deep === true ? Infinity : deep\n    getter = () => traverse(baseGetter(), depth)\n  }\n\n  let oldValue: any\n\n  let cleanup = null\n\n  function onCleanup(cb) {\n    cleanup = cb\n  }\n\n  function job() {\n    if (cleanup) {\n      // \u6E05\u7406\u4E0A\u4E00\u6B21\u7684\u526F\u4F5C\u7528\n      cleanup()\n      cleanup = null\n    }\n\n    // \u6267\u884C effect.run \u62FF\u5230 getter \u7684\u8FD4\u56DE\u503C\uFF0C\u4E0D\u80FD\u76F4\u63A5\u6267\u884C getter\uFF0C\u56E0\u4E3A\u8981\u6536\u96C6\u4F9D\u8D56\n    const newValue = effect.run()\n    // \u6267\u884C\u7528\u6237\u56DE\u8C03\uFF0C\u628A newValue \u548C oldValue \u4F20\u8FDB\u53BB\n    cb(newValue, oldValue, onCleanup)\n    // \u4E0B\u4E00\u6B21\u7684 oldValue \u5C31\u7B49\u4E8E\u8FD9\u4E00\u6B21\u7684 newValue\n    oldValue = newValue\n  }\n\n  const effect = new ReactiveEffect(getter)\n\n  effect.scheduler = job\n\n  if (immediate) {\n    job()\n  } else {\n    // \u62FF\u5230 oldValue,\u5E76\u4E14\u6536\u96C6\u4F9D\u8D56\n    oldValue = effect.run()\n  }\n\n  function stop() {\n    effect.stop()\n  }\n\n  return stop\n}\n\nfunction traverse(\n  value: unknown,\n  depth: number = Infinity,\n  seen: Set<unknown> = new Set(),\n) {\n  if (depth <= 0 || !isObject(value) || seen.has(value)) return value\n\n  depth--\n  seen.add(value)\n\n  for (const key in value) {\n    traverse(value[key], depth, seen)\n  }\n\n  return value\n}\n"],
  "mappings": "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",
  "names": ["link", "effect", "ref", "target", "cb", "effect"]
}
