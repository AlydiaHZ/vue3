{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["// \u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684 effect\nimport { Link } from './system'\n\nexport let activeSub\n\nexport class ReactiveEffect<T = any> {\n  // \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5934\u8282\u70B9\n  deps: Link | undefined\n  // \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5C3E\u8282\u70B9\n  depsTail: Link | undefined\n\n  constructor(public fn: () => T) {}\n\n  run(): T {\n    // \u5148\u5C06\u5F53\u524D\u7684 effect \u4FDD\u5B58\u8D77\u6765\uFF0C\u7528\u6765\u5904\u7406\u5D4C\u5957\u7684\u903B\u8F91\n    const prevSub = activeSub\n\n    // \u6BCF\u6B21\u6267\u884C fn \u4E4B\u524D\uFF0C\u628A this \u653E\u5230 activeSub\u4E0A\u9762\n    activeSub = this\n    this.depsTail = undefined\n\n    try {\n      return this.fn()\n    } finally {\n      // \u6267\u884C\u5B8C\u6210\u540E\uFF0C\u6062\u590D\u4E4B\u524D\u7684activeSub\n      activeSub = prevSub\n    }\n  }\n\n  /**\n   * \u901A\u77E5\u66F4\u65B0\u7684\u65B9\u6CD5\uFF0C\u5982\u679C\u4F9D\u8D56\u7684\u6570\u636E\u53D1\u751F\u4E86\u53D8\u5316\uFF0C\u4F1A\u8C03\u7528\u8FD9\u4E2A\u51FD\u6570\n   */\n  notify() {\n    this.scheduler()\n  }\n\n  /**\n   * \u9ED8\u8BA4\u8C03\u7528 run\uFF0C\u5982\u679C\u7528\u6237\u4F20\u4E86\uFF0C\u90A3\u4EE5\u7528\u6237\u7684\u4E3A\u4E3B\uFF0C\u5B9E\u4F8B\u5C5E\u6027\u7684\u4F18\u5148\u7EA7\uFF0C\u4F18\u4E8E\u539F\u578B\u5C5E\u6027\n   */\n  scheduler() {\n    this.run()\n  }\n}\n\nexport function effect<T = any>(fn: () => T, options?: any) {\n  const e = new ReactiveEffect(fn)\n\n  Object.assign(e, options)\n\n  e.run()\n\n  const runner = e.run.bind(e)\n  runner.effect = e\n  return runner\n}\n", "import { ReactiveEffect } from './effect'\n\n/**\n * \u4F9D\u8D56\u9879\n */\ninterface Dep {\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\n  subs: Link | undefined\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\n  subsTail: Link | undefined\n}\n\n/**\n * \u8BA2\u9605\u8005\n */\ninterface Sub {\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\n  deps: Link | undefined\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\n  depsTail: Link | undefined\n}\n\n/**\n * \u94FE\u8868\u8282\u70B9\n */\nexport interface Link {\n  // \u8BA2\u9605\u8005\n  sub: Sub\n  // \u4E0B\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\n  nextSub: Link | undefined\n  // \u4E0A\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\n  prevSub: Link | undefined\n  // \u4F9D\u8D56\u9879\n  dep: Dep\n  // \u4E0B\u4E00\u4E2A\u4F9D\u8D56\u9879\u8282\u70B9\n  nextDep: Link | undefined\n}\n\n/**\n * \u5EFA\u7ACB\u94FE\u8868\u5173\u7CFB\n * @param dep\n * @param sub\n */\nexport function link(dep: Dep, sub: ReactiveEffect) {\n  //region \u5C1D\u8BD5\u590D\u7528\u94FE\u8868\u8282\u70B9\n  const currentDep = sub.depsTail\n  /**\n   * \u5206\u4E24\u79CD\u60C5\u51B5\uFF1A\n   * \u5982\u679C\u5934\u8282\u70B9\u6709\uFF0C\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u90A3\u4E48\u5C1D\u8BD5\u590D\u7528\u5934\u8282\u70B9\n   * \u5982\u679C\u5C3E\u8282\u70B9\u8FD8\u6709 nextDep\uFF0C\u5C1D\u8BD5\u590D\u7528\u5C3E\u8282\u70B9\u7684 nextDep\n   */\n  const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep\n  if (nextDep && nextDep.dep === dep) {\n    sub.depsTail = nextDep\n    return\n  }\n  //endregion\n\n  // \u5982\u679C activeSub \u6709\uFF0C\u90A3\u5C31\u4FDD\u5B58\u8D77\u6765\uFF0C\u7B49\u6211\u66F4\u65B0\u7684\u65F6\u5019\uFF0C\u89E6\u53D1\n  const newLink: Link = {\n    sub,\n    nextSub: undefined,\n    prevSub: undefined,\n    dep,\n    nextDep: undefined,\n  }\n\n  //region \u5C06\u94FE\u8868\u8282\u70B9\u548C dep \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\n  /**\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB\uFF0C\u5206\u4E24\u79CD\u60C5\u51B5\n   * 1. \u6709\u5C3E\u8282\u70B9 => \u5C3E\u8282\u70B9\u540E\u52A0\n   * 2. \u6CA1\u5C3E\u8282\u70B9 => \u7B2C\u4E00\u6B21\u5173\u8054\uFF0C\u5934\u8282\u70B9\u52A0\uFF0C\u5934\u5C3E\u76F8\u540C\n   */\n  if (dep.subsTail) {\n    dep.subsTail.nextSub = newLink\n    newLink.prevSub = dep.subsTail\n    dep.subsTail = newLink\n  } else {\n    dep.subs = newLink\n    dep.subsTail = newLink\n  }\n  //endregion\n\n  //region \u5C06\u94FE\u8868\u8282\u70B9\u548C sub \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\n  /**\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB\uFF0C\u5206\u4E24\u79CD\u60C5\u51B5\n   * 1. \u6709\u5C3E\u8282\u70B9 => \u5C3E\u8282\u70B9\u540E\u52A0\n   * 2. \u6CA1\u5C3E\u8282\u70B9 => \u7B2C\u4E00\u6B21\u5173\u8054\uFF0C\u5934\u8282\u70B9\u52A0\uFF0C\u5934\u5C3E\u76F8\u540C\n   */\n  if (sub.depsTail) {\n    sub.depsTail.nextDep = newLink\n    sub.depsTail = newLink\n  } else {\n    sub.deps = newLink\n    sub.depsTail = newLink\n  }\n  //endregion\n}\n\n/**\n * \u4F20\u64AD\u66F4\u65B0\u7684\u51FD\u6570\n * @param subs\n */\nexport function propagate(subs) {\n  // \u5934\u8282\u70B9\n  let link = subs\n  let queueEffect = []\n  while (link) {\n    queueEffect.push(link.sub)\n    link = link.nextSub\n  }\n\n  queueEffect.forEach(effect => effect.notify())\n}\n", "import { activeSub } from './effect'\nimport { Link, link, propagate } from './system'\nimport { ReactiveFlags } from './constants'\n\n/**\n * \u5224\u65AD\u662F\u5426\u662Fref\n * @param r\n */\nexport function isRef(r: any) {\n  return !!(r && r[ReactiveFlags.IS_REF])\n}\n\n/**\n * ref \u4E3B\u51FD\u6570\n * @param value\n */\nexport function ref(value?: unknown) {\n  if (isRef(value)) {\n    return value\n  }\n  return new RefImpl(value)\n}\n\n/**\n * Ref \u7684\u7C7B\n */\nclass RefImpl<T = any> {\n  _value: T\n  public readonly [ReactiveFlags.IS_REF] = true\n\n  // \u5934\u8282\u70B9\n  subs: Link\n  // \u5C3E\u8282\u70B9\n  subsTail: Link\n\n  constructor(value: T) {\n    this._value = value\n  }\n\n  get value() {\n    // \u6536\u96C6\u4F9D\u8D56\n    trackRef(this)\n    return this._value\n  }\n\n  set value(newValue) {\n    // \u89E6\u53D1\u66F4\u65B0\n    this._value = newValue\n    triggerRef(this)\n  }\n}\n\n/**\n * \u6536\u96C6\u4F9D\u8D56\uFF0C\u5EFA\u7ACB ref \u548C effect \u4E4B\u95F4\u7684\u94FE\u8868\u5173\u7CFB\n * @param dep\n */\nexport function trackRef(dep: RefImpl) {\n  if (activeSub) {\n    link(dep, activeSub)\n  }\n}\n\n/**\n * \u89E6\u53D1 ref \u5173\u8054 effect \u91CD\u65B0\u6267\u884C\n * @param dep\n */\nexport function triggerRef(dep: RefImpl) {\n  if (dep.subs) {\n    propagate(dep.subs)\n  }\n}\n"],
  "mappings": ";AAGO,IAAI;AAEJ,IAAM,iBAAN,MAA8B;AAAA,EAMnC,YAAmB,IAAa;AAAb;AAAA,EAAc;AAAA;AAAA,EAJjC;AAAA;AAAA,EAEA;AAAA,EAIA,MAAS;AAEP,UAAM,UAAU;AAGhB,gBAAY;AACZ,SAAK,WAAW;AAEhB,QAAI;AACF,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AAEA,kBAAY;AAAA,IACd;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AACF;AAEO,SAAS,OAAgB,IAAa,SAAe;AAC1D,QAAM,IAAI,IAAI,eAAe,EAAE;AAE/B,SAAO,OAAO,GAAG,OAAO;AAExB,IAAE,IAAI;AAEN,QAAM,SAAS,EAAE,IAAI,KAAK,CAAC;AAC3B,SAAO,SAAS;AAChB,SAAO;AACT;;;ACXO,SAAS,KAAK,KAAU,KAAqB;AAElD,QAAM,aAAa,IAAI;AAMvB,QAAM,UAAU,eAAe,SAAY,IAAI,OAAO,WAAW;AACjE,MAAI,WAAW,QAAQ,QAAQ,KAAK;AAClC,QAAI,WAAW;AACf;AAAA,EACF;AAIA,QAAM,UAAgB;AAAA,IACpB;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,IACT;AAAA,IACA,SAAS;AAAA,EACX;AAQA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAS,UAAU;AACvB,YAAQ,UAAU,IAAI;AACtB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AASA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAS,UAAU;AACvB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AAEF;AAMO,SAAS,UAAU,MAAM;AAE9B,MAAIA,QAAO;AACX,MAAI,cAAc,CAAC;AACnB,SAAOA,OAAM;AACX,gBAAY,KAAKA,MAAK,GAAG;AACzB,IAAAA,QAAOA,MAAK;AAAA,EACd;AAEA,cAAY,QAAQ,CAAAC,YAAUA,QAAO,OAAO,CAAC;AAC/C;;;ACzGO,SAAS,MAAM,GAAQ;AAC5B,SAAO,CAAC,EAAE,KAAK,0BAAsB;AACvC;AAMO,SAAS,IAAI,OAAiB;AACnC,MAAI,MAAM,KAAK,GAAG;AAChB,WAAO;AAAA,EACT;AACA,SAAO,IAAI,QAAQ,KAAK;AAC1B;AAKA,IAAM,UAAN,MAAuB;AAAA,EACrB;AAAA,EACA,yBAAqC,IAAI;AAAA;AAAA,EAGzC;AAAA;AAAA,EAEA;AAAA,EAEA,YAAY,OAAU;AACpB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAQ;AAEV,aAAS,IAAI;AACb,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,MAAM,UAAU;AAElB,SAAK,SAAS;AACd,eAAW,IAAI;AAAA,EACjB;AACF;AAMO,SAAS,SAAS,KAAc;AACrC,MAAI,WAAW;AACb,SAAK,KAAK,SAAS;AAAA,EACrB;AACF;AAMO,SAAS,WAAW,KAAc;AACvC,MAAI,IAAI,MAAM;AACZ,cAAU,IAAI,IAAI;AAAA,EACpB;AACF;",
  "names": ["link", "effect"]
}
