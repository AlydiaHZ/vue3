{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["// \u4E34\u65F6\u9700\u8981\u6267\u884C\u7684\u8BA2\u9605\u4E8B\u4EF6\nimport { Link } from './system'\n\nexport let activeSub: ReactiveEffect\n\nclass ReactiveEffect {\n  depsHead: Link | undefined\n  depsTail: Link | undefined\n\n  constructor(public fn: Function) {}\n\n  run() {\n    const prevSub: ReactiveEffect | undefined = activeSub\n\n    // \u6BCF\u6B21\u6267\u884C fn \u4E4B\u524D\uFF0C\u628A this \u653E\u5230 activeSub \u4E0A\u9762\n    activeSub = this\n\n    try {\n      return this.fn()\n    } finally {\n      // \u6267\u884C\u5B8C\u6210\u540E\uFF0C\u6062\u590D\u4E4B\u524D\u7684 activeSub\n      activeSub = prevSub\n    }\n  }\n\n  /**\n   * \u901A\u77E5\u66F4\u65B0\u7684\u65B9\u6CD5\uFF0C\u5982\u679C\u4F9D\u8D56\u7684\u6570\u636E\u53D1\u751F\u53D8\u5316\uFF0C\u4F1A\u8C03\u7528\u8FD9\u4E2A\u51FD\u6570\n   */\n  notify() {\n    this.scheduler()\n  }\n\n  /**\n   * \u9ED8\u8BA4\u8C03\u7528 run\uFF0C\u5982\u679C\u7528\u6237\u4F20\u4E86\uFF0C\u90A3\u4EE5\u7528\u6237\u7684\u4E3A\u4E3B\n   */\n  scheduler() {\n    this.run()\n  }\n}\n\n/**\n * \u8BA2\u9605 ref\n * @param fn \u8BA2\u9605\u4E8B\u4EF6\n * @param options\n */\nexport function effect<T = any>(fn: () => T, options?: any) {\n  const e = new ReactiveEffect(fn)\n  // scheduler\n  Object.assign(e, options)\n\n  e.run()\n\n  // \u7ED1\u5B9A\u51FD\u6570\u7684 this\n  const runner = e.run.bind(e)\n  // \u628A effect \u7684\u5B9E\u4F8B\uFF0C\u653E\u5230\u51FD\u6570\u5C5E\u6027\u4E2D\n  runner.effect = e\n  return runner\n}\n", "import { RefImpl } from './ref'\nimport { ReactiveEffect } from 'vue'\n\n/**\n * \u4F9D\u8D56\u9879\n */\ninterface Dep {\n  subsHead: Link | undefined\n  subsTail: Link | undefined\n}\n\n/**\n * \u8BA2\u9605\u8005\n */\ninterface Sub {\n  subsHead: Link | undefined\n  subsTail: Link | undefined\n}\n\n/**\n * \u94FE\u8868\u8282\u70B9\n */\nexport interface Link {\n  sub: ReactiveEffect\n  nextSub: Link | undefined\n  prevSub: Link | undefined\n  dep: Dep\n  nextDep: Link | undefined\n  prevDep: Link | undefined\n}\n\n/**\n *\n * @param dep \u5F53\u524D\u7684 ref\n * @param sub \u4E34\u65F6\u8BA2\u9605\u4E8B\u4EF6\n */\nexport function link(dep: RefImpl, sub: ReactiveEffect) {\n  // \u65B0\u5EFA\u8282\u70B9\n  const newLink: Link = {\n    sub,\n    nextSub: undefined,\n    prevSub: undefined,\n    dep,\n    nextDep: undefined,\n    prevDep: undefined,\n  }\n\n  //region \u5C06\u94FE\u8868\u8282\u70B9\u548C dep \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\n  // \u5C06\u8282\u70B9\u653E\u5165\u672C ref \u7684\u8BA2\u9605\u8005\u94FE\u8868\u4E2D\n  if (dep.subsTail) {\n    // \u5982\u679C\u6709\u5C3E\u8282\u70B9 => \u4E0D\u662F\u5934\u8282\u70B9 => \u5728\u94FE\u8868\u540E\u9762\u52A0\u5165\n    dep.subsTail.nextSub = newLink\n    newLink.prevSub = dep.subsTail\n    dep.subsTail = newLink\n  } else {\n    // \u5982\u679C\u65E0\u5C3E\u8282\u70B9 => \u662F\u5934\u8282\u70B9 => \u8BBE\u7F6E\u4E3A\u5934\u8282\u70B9\n    dep.subsHead = newLink\n    dep.subsTail = newLink\n  }\n  //endregion\n}\n\n/**\n * \u4F20\u64AD\u66F4\u65B0\u7684\u51FD\u6570\n * @param subs\n */\nexport function propagate(subs: Link) {\n  let link = subs\n  let queuedEffect = []\n  while (link) {\n    queuedEffect.push(link.sub)\n    link = link.nextSub\n  }\n  queuedEffect.forEach(effect => effect.notify())\n}\n", "import { activeSub } from './effect'\nimport { Link, link, propagate } from './system'\n\nexport class RefImpl<T = any> {\n  _value: T\n\n  subsHead: Link\n  subsTail: Link\n\n  constructor(value: T) {\n    this._value = value\n  }\n\n  get value() {\n    trackRef(this)\n    return this._value\n  }\n\n  set value(newValue) {\n    this._value = newValue\n    triggerRef(this)\n  }\n}\n\nexport function ref(value: unknown) {\n  return new RefImpl(value)\n}\n\n/**\n * \u6536\u96C6\u8BA2\u9605\n * @param dep\n */\nexport function trackRef(dep: RefImpl) {\n  if (activeSub) link(dep, activeSub)\n}\n\n/**\n * \u89E6\u53D1 ref \u5173\u8054\u7684\u6240\u6709 effect\n * @param dep\n */\nexport function triggerRef(dep: RefImpl) {\n  if (dep.subsHead) {\n    propagate(dep.subsHead)\n  }\n}\n"],
  "mappings": ";AAGO,IAAI;AAEX,IAAM,iBAAN,MAAqB;AAAA,EAInB,YAAmB,IAAc;AAAd;AAAA,EAAe;AAAA,EAHlC;AAAA,EACA;AAAA,EAIA,MAAM;AACJ,UAAM,UAAsC;AAG5C,gBAAY;AAEZ,QAAI;AACF,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AAEA,kBAAY;AAAA,IACd;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AACF;AAOO,SAAS,OAAgB,IAAa,SAAe;AAC1D,QAAM,IAAI,IAAI,eAAe,EAAE;AAE/B,SAAO,OAAO,GAAG,OAAO;AAExB,IAAE,IAAI;AAGN,QAAM,SAAS,EAAE,IAAI,KAAK,CAAC;AAE3B,SAAO,SAAS;AAChB,SAAO;AACT;;;ACrBO,SAAS,KAAK,KAAc,KAAqB;AAEtD,QAAM,UAAgB;AAAA,IACpB;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,IACT;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,EACX;AAIA,MAAI,IAAI,UAAU;AAEhB,QAAI,SAAS,UAAU;AACvB,YAAQ,UAAU,IAAI;AACtB,QAAI,WAAW;AAAA,EACjB,OAAO;AAEL,QAAI,WAAW;AACf,QAAI,WAAW;AAAA,EACjB;AAEF;AAMO,SAAS,UAAU,MAAY;AACpC,MAAIA,QAAO;AACX,MAAI,eAAe,CAAC;AACpB,SAAOA,OAAM;AACX,iBAAa,KAAKA,MAAK,GAAG;AAC1B,IAAAA,QAAOA,MAAK;AAAA,EACd;AACA,eAAa,QAAQ,CAAAC,YAAUA,QAAO,OAAO,CAAC;AAChD;;;ACvEO,IAAM,UAAN,MAAuB;AAAA,EAC5B;AAAA,EAEA;AAAA,EACA;AAAA,EAEA,YAAY,OAAU;AACpB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAQ;AACV,aAAS,IAAI;AACb,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,MAAM,UAAU;AAClB,SAAK,SAAS;AACd,eAAW,IAAI;AAAA,EACjB;AACF;AAEO,SAAS,IAAI,OAAgB;AAClC,SAAO,IAAI,QAAQ,KAAK;AAC1B;AAMO,SAAS,SAAS,KAAc;AACrC,MAAI,UAAW,MAAK,KAAK,SAAS;AACpC;AAMO,SAAS,WAAW,KAAc;AACvC,MAAI,IAAI,UAAU;AAChB,cAAU,IAAI,QAAQ;AAAA,EACxB;AACF;",
  "names": ["link", "effect"]
}
